import type { ErrorCodeType } from '@aido/errors';
import type { AfterResponseHook } from 'ky';

const MOBILE_ERROR_MESSAGES: Partial<Record<ErrorCodeType, string>> = {
  // =========================================================================
  // 시스템/공통 (SYS)
  // =========================================================================
  SYS_0001: '서버 오류가 발생했어요. 잠시 후 다시 시도해주세요.',
  SYS_0002: '잘못된 요청이에요',
  SYS_0003: '다른 곳에서 수정되었어요. 다시 시도해주세요.',
  SYS_0004: '동시 수정 충돌이 발생했어요. 다시 시도해주세요.',

  // =========================================================================
  // 인증/JWT (AUTH) - 보안: 구체적 원인 숨김
  // =========================================================================
  AUTH_0101: '인증 정보가 올바르지 않아요. 다시 로그인해주세요.',
  AUTH_0102: '로그인이 만료되었어요. 다시 로그인해주세요.',
  AUTH_0103: '인증 정보가 올바르지 않아요. 다시 로그인해주세요.',
  AUTH_0104: '인증 정보가 올바르지 않아요. 다시 로그인해주세요.',
  AUTH_0105: '로그인이 만료되었어요. 다시 로그인해주세요.',
  AUTH_0106: '다시 로그인해주세요.',
  AUTH_0107: '로그인이 필요한 기능이에요',
  AUTH_0108: '접근 권한이 없어요',

  // =========================================================================
  // 소셜 로그인 공통 (SOCIAL)
  // =========================================================================
  SOCIAL_0201: '소셜 로그인에 실패했어요. 다시 시도해주세요.',
  SOCIAL_0202: '소셜 인증 정보가 유효하지 않아요. 다시 시도해주세요.',
  SOCIAL_0203: '소셜 인증이 만료되었어요. 다시 시도해주세요.',
  SOCIAL_0204: '소셜 서비스 연결에 문제가 생겼어요. 잠시 후 다시 시도해주세요.',
  SOCIAL_0205: '이메일 정보를 가져올 수 없어요. 소셜 계정 설정을 확인해주세요.',
  SOCIAL_0206: '연동된 계정이 없어요',

  // =========================================================================
  // 카카오 (KAKAO)
  // =========================================================================
  KAKAO_0301: '카카오 로그인에 실패했어요. 다시 시도해주세요.',
  KAKAO_0302: '카카오 인증이 만료되었어요. 다시 시도해주세요.',
  KAKAO_0303: '카카오 로그인에 실패했어요. 다시 시도해주세요.',
  KAKAO_0304: '카카오 인증에 실패했어요. 다시 시도해주세요.',
  KAKAO_0305: '카카오 정보를 가져올 수 없어요. 잠시 후 다시 시도해주세요.',
  KAKAO_0306: '이미 다른 계정에 연동된 카카오 계정이에요',
  KAKAO_0307: '카카오 연동 해제에 실패했어요. 잠시 후 다시 시도해주세요.',
  KAKAO_0308: '카카오 인증에 실패했어요. 다시 시도해주세요.',

  // =========================================================================
  // 애플 (APPLE)
  // =========================================================================
  APPLE_0351: '애플 로그인에 실패했어요. 다시 시도해주세요.',
  APPLE_0352: '애플 인증에 실패했어요. 다시 시도해주세요.',
  APPLE_0353: '애플 인증이 만료되었어요. 다시 시도해주세요.',
  APPLE_0354: '애플 인증에 실패했어요. 다시 시도해주세요.',
  APPLE_0355: '이미 다른 계정에 연동된 애플 계정이에요',
  APPLE_0356: '애플 연동 해제에 실패했어요. 잠시 후 다시 시도해주세요.',
  APPLE_0357: '애플 로그아웃에 실패했어요. 잠시 후 다시 시도해주세요.',

  // =========================================================================
  // 구글 (GOOGLE)
  // =========================================================================
  GOOGLE_0401: '구글 로그인에 실패했어요. 다시 시도해주세요.',
  GOOGLE_0402: '구글 인증에 실패했어요. 다시 시도해주세요.',
  GOOGLE_0403: '구글 인증에 실패했어요. 다시 시도해주세요.',
  GOOGLE_0404: '구글 계정에서 이메일 정보를 가져올 수 없어요',
  GOOGLE_0405: '이미 다른 계정에 연동된 구글 계정이에요',
  GOOGLE_0406: '구글 연동 해제에 실패했어요. 잠시 후 다시 시도해주세요.',

  // =========================================================================
  // 네이버 (NAVER)
  // =========================================================================
  NAVER_0451: '네이버 로그인에 실패했어요. 다시 시도해주세요.',
  NAVER_0452: '네이버 인증에 실패했어요. 다시 시도해주세요.',
  NAVER_0453: '네이버 인증에 실패했어요. 다시 시도해주세요.',
  NAVER_0454: '네이버 정보를 가져올 수 없어요. 잠시 후 다시 시도해주세요.',
  NAVER_0455: '이미 다른 계정에 연동된 네이버 계정이에요',
  NAVER_0456: '네이버 연동 해제에 실패했어요. 잠시 후 다시 시도해주세요.',

  // =========================================================================
  // 이메일 인증 (EMAIL) - 보안: 존재 여부/비밀번호 구체적 원인 숨김
  // =========================================================================
  EMAIL_0501: '이미 가입된 이메일이에요',
  EMAIL_0502: '입력 정보를 확인해주세요', // 보안: 이메일 존재 여부 숨김
  EMAIL_0503: '이메일 인증이 필요해요',
  EMAIL_0504: '인증 코드가 올바르지 않아요',
  EMAIL_0505: '인증 코드가 만료되었어요. 다시 요청해주세요.',
  EMAIL_0506: '이메일 발송에 실패했어요. 잠시 후 다시 시도해주세요.',
  EMAIL_0507: '입력 정보를 확인해주세요', // 보안: 비밀번호 틀림 숨김
  EMAIL_0508: '비밀번호가 일치하지 않아요',

  // =========================================================================
  // 사용자/계정 (USER) - 보안: 로그인 실패 원인 숨김
  // =========================================================================
  USER_0601: '사용자를 찾을 수 없어요',
  USER_0602: '이메일 또는 비밀번호를 확인해주세요', // 보안: 어떤 것이 틀렸는지 숨김
  USER_0603: '연동된 계정을 찾을 수 없어요',
  USER_0604: '이미 가입된 계정이에요',
  USER_0605: '정지된 계정이에요. 고객센터에 문의해주세요.',
  USER_0606: '탈퇴한 계정이에요',
  USER_0607: '계정이 잠겼어요. 잠시 후 다시 시도해주세요.',
  USER_0608: '이메일 인증이 필요해요. 이메일을 확인해주세요.',
  USER_0609: '로그인 시도가 너무 많아요. 잠시 후 다시 시도해주세요.',
  USER_0610: '마지막 로그인 수단은 해제할 수 없어요',

  // =========================================================================
  // 세션 (SESSION)
  // =========================================================================
  SESSION_0701: '세션이 유효하지 않아요. 다시 로그인해주세요.',
  SESSION_0702: '세션이 만료되었어요. 다시 로그인해주세요.',
  SESSION_0703: '세션이 종료되었어요. 다시 로그인해주세요.',
  SESSION_0704: '보안상의 이유로 로그아웃되었어요. 다시 로그인해주세요.',

  // =========================================================================
  // 인증 코드 (VERIFY)
  // =========================================================================
  VERIFY_0751: '인증 코드가 올바르지 않아요',
  VERIFY_0752: '인증 코드가 만료되었어요. 다시 요청해주세요.',
  VERIFY_0753: '1분 후에 다시 요청해주세요',
  VERIFY_0754: '인증 시도 횟수를 초과했어요. 새 코드를 요청해주세요.',

  // =========================================================================
  // Todo (TODO)
  // =========================================================================
  TODO_0801: '할 일을 찾을 수 없어요',

  // =========================================================================
  // 친구/팔로우 (FOLLOW)
  // =========================================================================
  FOLLOW_0901: '이미 친구 요청을 보냈어요',
  FOLLOW_0902: '이미 친구예요',
  FOLLOW_0903: '친구 요청을 찾을 수 없어요',
  FOLLOW_0904: '자기 자신에게는 친구 요청을 보낼 수 없어요',
  FOLLOW_0905: '사용자를 찾을 수 없어요',
  FOLLOW_0906: '친구가 아닌 사용자의 투두는 볼 수 없어요',
  FOLLOW_0907: '친구가 아니에요',
  FOLLOW_0908: '이미 상대방이 친구 요청을 보냈어요',

  // =========================================================================
  // 알림/푸시 (NOTIFICATION)
  // =========================================================================
  NOTIFICATION_1001: '푸시 알림 설정에 문제가 있어요',
  NOTIFICATION_1002: '알림을 받을 수 없는 상태예요. 앱 설정을 확인해주세요.',
  NOTIFICATION_1003: '알림 발송에 실패했어요',
  NOTIFICATION_1004: '알림을 찾을 수 없어요',
  NOTIFICATION_1005: '알림에 접근할 수 없어요',

  // =========================================================================
  // 독촉 (NUDGE)
  // =========================================================================
  NUDGE_1101: '오늘 독촉 횟수를 모두 사용했어요',
  NUDGE_1102: '24시간 후에 다시 독촉할 수 있어요',
  NUDGE_1103: '친구에게만 독촉할 수 있어요',
  NUDGE_1104: '자신에게는 독촉할 수 없어요',
  NUDGE_1105: '독촉을 찾을 수 없어요',

  // =========================================================================
  // 응원 (CHEER)
  // =========================================================================
  CHEER_1201: '오늘 응원 횟수를 모두 사용했어요',
  CHEER_1202: '24시간 후에 다시 응원할 수 있어요',
  CHEER_1203: '친구에게만 응원할 수 있어요',
  CHEER_1204: '자신에게는 응원할 수 없어요',
  CHEER_1205: '응원을 찾을 수 없어요',

  // =========================================================================
  // AI 서비스 (AI)
  // =========================================================================
  AI_0001: 'AI 서비스를 일시적으로 사용할 수 없어요',
  AI_0002: '문장을 이해하지 못했어요. 다시 시도해주세요.',
  AI_0003: '오늘 AI 사용 횟수를 모두 사용했어요',
};

interface ServerErrorResponse {
  success: false;
  error: { code: string; message: string };
}

export const handleApiErrors: AfterResponseHook = async (_request, _options, response) => {
  // 401은 refresh 로직에서 처리하므로 건너뜀
  if (!response.ok && response.status !== 401) {
    const { error } = (await response.json()) as ServerErrorResponse;
    const userMessage =
      MOBILE_ERROR_MESSAGES[error.code as ErrorCodeType] ||
      error.message ||
      '알 수 없는 오류가 발생했어요';
    throw new Error(userMessage);
  }
};
